<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/polymerfire/firebase-auth.html">  
<link rel="import" href="../bower_components/polymerfire/firebase-query.html">  
<link rel="import" href="../bower_components/polymerfire/firebase-document.html">  
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">    
<link rel="import" href="../bower_components/paper-menu-button/paper-menu-button.html">  
<link rel="import" href="../bower_components/app-layout/app-drawer/app-drawer.html"> 
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">  
<link rel="import" href="word-swarm-console.html">
<link rel="import" href="word-swarm-engine.html">
<dom-module id="word-swarm-view">
    <template>
        <style>
             word-swarm-engine {
                position: fixed;
                top: 0;
                left: 0;
                min-width: 100vw;
                min-height: 100vh;
                overflow: visible;
            } 
             word-swarm-word{
                z-index: 1;
            } 
            word-swarm-console > word-swarm-word{
                -webkit-transition: all 1.5s ease-in-out;
                transition: all 1.5s ease-in-out;
            }
            word-swarm-word:hover{
                z-index: 2;
                transform: translate(0px,0px)
            }
            paper-icon-button#addButton {
                background-color:rgb(204, 24, 30); 
                color:white; 
                border-radius:20px;
                position: absolute;
                bottom: 20px;
                left: 20px;
                z-index: 3;
            }
            app-drawer{               
                pointer-events: none;
                top: 0;
                --app-drawer-content-container:{
                    background-color: transparent;
                }
            }
            app-drawer > word-swarm-console{
                pointer-events: all;
            }
        </style>
        <firebase-auth user="{{user}}"></firebase-auth>
        <firebase-document
            id="userSwarm"
            path="/users/[[user.uid]]/swarms/[[swarm]]"
            data={{userSwarm}}>
        </firebase-document>
        <firebase-query
            id="words"
            path="/swarms/[[userSwarm.swarmId]]/words"
            data={{words}}>
        </firebase-query>
        <firebase-query
            id="userWords"
            path="/swarms/[[userSwarm.swarmId]]/users/[[user.uid]]/wordsAdded"
            data={{uswerWords}}>
        </firebase-query>
        
        <word-swarm-engine id="wordSwarm" wordlist=[[swarmWords]]>
            <template is="dom-repeat" items="[[swarmWords]]" as="word">
                <word-swarm-word id="[[word.$key]]" class="swarm" holding name="[[word.name]]">[[word.name]]</word-swarm-word>
            </template>
        </word-swarm-engine>
        <app-drawer id="consoledrawer" persistent align="right">
            <word-swarm-console id="wordConsole" wordlist=[[consoleWords]]>
                <template is="dom-repeat" items="[[consoleWords]]" as="word">
                    <word-swarm-word on-tap="_consoleWordTapped" id="[[word.$key]]" class="console" holding name="[[word.name]]">[[word.name]]</word-swarm-word>
                </template>
            </word-swarm-console>
        </app-drawer>

        <paper-dialog id="word">
            <paper-input id="newWord"></paper-input>
            <div class="buttons">
                <paper-button on-tap="_addWord">Add</paper-button>
            </div>
        </paper-dialog>

        <paper-icon-button id="addButton" icon="add" on-click="_addWordDialog"></paper-icon-button>

    </template>
    <script>
      // define the element's class element
      class wordSwarmView extends Polymer.Element {
        static get is() { return 'word-swarm-view'; }
        connectedCallback() {
          super.connectedCallback();
          requestAnimationFrame(this._installListeners.bind(this));
        }
        ready() {
          super.ready();
          console.log("viewing: "+this.swarm)
          this.$.consoledrawer.open();
        }
        static get properties(){
            return{
                swarm:{
                    type: String,
                    notify:true,
                    observer:"_swarmChosen"
                },
                words:{
                    type: Array,
                },
                userWords:{
                    type:Array,
                    //notify:true,
                    value:[]
                },
                swarmWords:{
                    type: Array,
                    notify:true,
                    value:[],
                },
                consoleWords:{
                    type: Array,
                    notify:true,
                    value:[]
                }
            }
      }
      static get observers() {
        return [
                '_updateWords(words.*)',
                '_userSwarmObserver(userSwarm.*)'
        ]
      }
      closeSim(){
         this.$.wordSwarm.sim.run = false;
      }
      openSim(){
          this.$.wordSwarm.sim.run = true;
          this.$.wordSwarm.sim.draw();
      }
      _installListeners() {
           this.$.word.addEventListener('iron-overlay-closed',()=>{
                this.$.newWord.value="";
            });
            this.addEventListener('stopMe',(e)=>{
                if(e.detail.className == "swarm"){
                this.$.wordSwarm.stopElement(e.detail)}
            });
            this.addEventListener('releaseMe',(e)=>{
                if(e.detail.className == "swarm"){
                this.$.wordSwarm.startElement(e.detail)}
            });
            this.addEventListener('chooseMe',(e)=>{
                if(e.detail.className == "swarm"){
                this._wordTapped(e.detail);}
            });
        }

       _updateWords(words){
            //if a word was added or changed update
            var exists=false
            this.words.forEach((el)=>{
                exists=false
                this.swarmWords.forEach((sw)=>{
                     if(el.$key==sw.$key)exists=true
                     else sw = el
                });
                if(!exists){
                    this.consoleWords.forEach((cw)=>{
                        if(el.$key==cw.$key)exists=true;
                        else cw=el;
                    });
                }
                if(!exists){
                    this.push('swarmWords',el);
                }
            })
            //if a word was removed, take it out of swarm or console.
            this.swarmWords.forEach((sw, index, object)=>{
                exists=false;
                this.words.forEach((el)=>{
                    if(el.$key==sw.$key)exists=true;
                })
                if(exists=false){this.splice('swarmWords',index,1)}
            });
            this.consoleWords.forEach((cw, index, object)=>{
                exists=false;
                this.words.forEach((el)=>{ 
                    if(el.$key==cw.$key)exists=true;
                })
                if(exists=false){this.splice('consoleWords',index,1)}
            });
        }
        _swarmChosen(){
            this.consoleWords=[];
            this.$.wordConsole.clearFixtures();
            this.swarmWords=[];
        }
        _userSwarmObserver(){      
        }
        _addWord(){
            this.$.userWords.ref.push({
                name:this.$.newWord.value,
                added:  {".sv": "timestamp"},
                update: true,
                wordId: false
            });
            this.$.newWord.value="";
            this.$.word.close();
        }
        _wordTapped(el){
            this.$.wordConsole.fixture(el.id, el.getBoundingClientRect());
            this.$.wordSwarm.removeWord(el)
            const id = el.id
            this.push('consoleWords',(this.swarmWords.filter(function(word){
                return word.$key == el.id
            })[0]));
        }
        _consoleWordTapped(e){
            this.$.wordSwarm.returnWordPos = this.$.wordConsole.removeWord(e.currentTarget);
            this.push('swarmWords',(this.consoleWords.filter(function(word){
                return word.$key == e.currentTarget.id
            })[0]));
        }
        _addWordDialog(){
            this.$.word.open()
        }
      }
      
      // Associate the new class with an element name
      window.customElements.define(wordSwarmView.is, wordSwarmView);
    </script>
</dom-module>