<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="../bower_components/polymer/lib/utils/flattened-nodes-observer.html">
<script type="text/javascript" src="bubbles/FieldItems.js"></script>
<script type="text/javascript" src="bubbles/SimFieldEngine.js"></script>
<script type="text/javascript" src="bubbles/SimController.js"></script>
<link rel="import" href="word-swarm-word.html">
<dom-module id="word-swarm-engine">
    <template>
        <style>
            #playground{
                width: 100vw;
                height: 100vh;
            }

        </style>
        <div id="playground">
        <slot id="slot"></slot>
        </div>
    </template>
    <script>
        class wordSwarmEngine extends Polymer.mixinBehaviors([Polymer.IronResizableBehavior], Polymer.Element) {
            static get is() { return 'word-swarm-engine';}
            connectedCallback() {
                super.connectedCallback();
                requestAnimationFrame(this._installListeners.bind(this));
            }
            ready() {
                super.ready();
                this._observer = new Polymer.FlattenedNodesObserver(this.$.slot, (info) => {
                    this._processNewNodes(info.addedNodes);
                    this._processRemovedNodes(info.removedNodes);
                });
                this.sim = new SimController(this.$.playground);
                var drawing = false;
                var animation = requestAnimationFrame(this.sim.draw.bind(this.sim));
                this.async(this.notifyResize, 1);
            }
            static get properties(){
                return{
                    wordlist:{
                        type:String,
                        notify:true,
                        value:"hello"
                    },
                    sim:{
                        type:Object
                    },
                    returnWordPos:{
                        type:Object,
                        value:{left:0,top:0}
                    }
                }
            }
            _installListeners() {
               this.addEventListener('iron-resize', this._onIronResize);
            }

            _processNewNodes(addedNodes){
                addedNodes.forEach((node)=> {           
                    if(node.id){
                        if(this.returnWordPos.left == 0){
                            this.sim.addObject(node);
                            node.holding = false;         
                        }
                        else{
                            this.sim.addObject(node,this.returnWordPos.left-50,this.returnWordPos.top-30);
                            node.holding = false;
                        }
                    }
                })
            }
            _processRemovedNodes(removedNodes){
                 removedNodes.forEach((node)=> {           
                     if(node.id){
                         this.sim.removeObject(node);
                     }
                })
            }
            removeWord(node){
                this.sim.removeObject(node)
            }
            stopElement(e){
                this.sim.stopElement(e);
            }
            startElement(e){
                this.sim.startElement(e);
            }
            _onIronResize(){
                this.sim.resize(this.clientWidth,this.clientHeight)
            }
            stopSim(){
                console.log("stop");
                this.sim.run = false;
            }
            
            

        }
    window.customElements.define(wordSwarmEngine.is, wordSwarmEngine);
    </script>
</dom-module>